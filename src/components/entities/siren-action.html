<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/polymer-siren-mixins/siren-action-mixin.html">
<link rel="import" href="../../styles/shared-styles.html">

<dom-module id="siren-action">
	<template>
		<style include="shared-styles">
			:host {
				display: block;
			}

			.form {
				width: 500px;
				max-width: 1000px;
				padding: 1em;
			}

			.form .input {
				padding: .25em;
			}

			paper-card {
				width: 100%;
				padding: 1em;
			}
			paper-input: {
				margin-top: .25em;
			}
			.right {
				float: right;
			}
			.toast {
				max-width: 500px;
				border: 1px solid #ccc;
				background-color: #fefefe;
				border-radius: 5px;
			}

		</style>
		<paper-card>
			<form class="form">
				<template is="dom-repeat" items="{{fields}}">
					<paper-input class="input" value="{{item.value}}" type="[[item.type]]" label="[[item.name]]" ></paper-input>
				</template>
				<paper-button raised class="indigo" on-click="_go" class="right">Execute</paper-button>
			</form>
		</paper-card>
		<paper-toast duration=0 text="[[text]]" opened=[[opened]]>
			<div>
				<div>
					[[errorText]]
				</div>
				<div>
					<paper-button raised on-click="_closeToast">Close</paper-button>
				</div>
			</div>
		</paper-toast>
	</template>
	<script>
		/* @mixes window.D2L.Polymer.Mixins.SirenActionMixin */
		class SirenAction extends window.D2L.Polymer.Mixins.SirenActionMixin(Polymer.Element) {
			static get is() {
				return 'siren-action';
			}
			static get properties() {
				return {
					href: {
						reflectToAttribute: true,
						notify: true,
					},
					action: {
						type: Object,
						reflectToAttribute: true,
					},
					fields: {
						type: Array,
						value: [],
					},
					opened: {
						type: Boolean,
						value: false
					},
					text: {
						type: String,
						value: ''
					},
					errorText: {
						type: String,
						value: ''
					}
				};
			}

			static get observers() {
				return [
					'_changed(action)',
				];
			}

			_go() {
				const self = this;
				const fieldObjects = this.getSirenFields(self.action);
				for (const field of self.fields) {
					if (field.value === undefined) {
						continue;
					}
					fieldObjects.set(field.name, field.value);
				}
				this.performSirenAction(self.action, fieldObjects)
						.then(function(){
							self.href = self.getEntityUrl(self.action, fieldObjects).href;
						})
						.catch(function(err){
							self.text = `Error executing action ${ self.action.name }`;
							self.errorText = err && err.message || '';
							self.opened = true;
						});
			}
			_closeToast(){
				this.opened = false;
			}
			_changed(action) {
				this.fields = action.fields || [];
			}
		}

		window.customElements.define(SirenAction.is, SirenAction);
	</script>
</dom-module>
